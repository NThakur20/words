<html>
    <head>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
        <style>
            body {
                padding-top: 70px;
            }
            .cards {
                vertical-align: middle;
                width: 100%;
                height: 80%;
                border-spacing: 10px;
                border-collapse: separate;
            }

            .cell {
                border-radius: 10px;
                text-align: center;
                font-weight: bold;
                font-size: 1.4vw;
                display: table-cell;
                max-width: 0px;
                max-height: 0px;
            }
            .cell-inrevealed {
                border: 2px dotted black;
            }
            .cell-inrevealed:hover {
                border: 2px solid black;
                cursor: pointer;
            }
            .cell-revealed {
                border: 2px solid black;
                cursor: auto;
            }
            .cell-red {
                background: #FFCCCC;
            }
            .cell-blue {
                background: #99CCFF;
            }
            .cell-neutral {
                background: #eeeeee;
            }
            .cell-end {
                background: black;
                color: white;
            }
            .red-stats {
                color: red;
            }
            .blue-stats {
                color: blue;
            }
            .cell-strike {
                opacity: 0.2;
            }


            .border-md-right {
                border-right: 1px solid silver;
            }

            @media (max-width: 768px) {
                .border-md-right {
                    border-right: none;
                }
            }
        </style>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg fixed-top navbar-light bg-light">
            <span class="navbar-brand">Words</span>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#menu" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="menu">
                <!-- navigation buttons -->
                <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                    <li class="nav-item"><a href='#' class="nav-link" data-toggle="modal" data-target="#about-modal">About</a></li>
                    <li id="spymaster-li"
                        class="nav-item"
                        data-toggle="tooltip"
                        data-placement="bottom"
                        title="Display the colors of all tiles.">
                        <a class="nav-link" href="#" id="spymaster">Spymaster</a>
                    </li>
                    <!-- spy assistant  -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          Spy Assistant
                        </a>
                        <div class="dropdown-menu text-muted" style="min-width:25rem">
                            <div class="form-group" id="recommend-lang-warning">
                                <div class="alert alert-warning" role="alert">
                                    Currently only works for english.
                                </div>
                            </div>
                            <div id="intro-recommend">
                                <form class="px-4 py-1">
                                    <div class="form-group text-justify">
                                        <small>Automated tool to recommend Spymaster clues. It works best towards endgame. It is based on the <a href="https://nlp.stanford.edu/projects/glove/">glove vectors</a>. This specific application was inspired by a <a href="https://jsomers.net/glove-codenames/">blog post</a> that I saw on hacker news.</small>
                                    </div>
                                    <div class="form-group text-center">
                                        <button class="btn btn-primary" id="enable-recommend">Enable</button>
                                    </div>
                                </form>
                            </div>
                            <div id="recommend-settings">
                                <h6 class="dropdown-header">Spy Assistant Settings</h6>

                                <form class="px-4 py-3">
                                    <div class="form-group">
                                        <label for="risk">
                                            Risk tolerance</br>
                                            <small>The number of bad words that are ignored when coming up with clues. Zeros words is the safest option, but might result in more awkward clues.</small>
                                        </label>
                                        <select class="form-control" id="risk">
                                            <option value="0">zero words</option>
                                            <option value="1">one word</option>
                                            <option value="2">two words</option>
                                            <option value="3">three words</option>
                                            <option value="allbutblack">all words (no black)</option>
                                            <option value="all">all words (including black)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="num-guesses">
                                            Target Words</br>
                                            <small>Number of words that the assistant will try to hint at. The larger the number the harder is it to come up with a sensible clue.</small>
                                        </label>
                                        <select class="form-control" id="num-guesses">
                                            <option value="1">one word</option>
                                            <option value="2">two words</option>
                                            <option value="3">three words</option>
                                            <option value="4">four words</option>
                                            <option value="5">five words</option>
                                        </select>
                                    </div>
                                    <div class="form-group text-center">
                                        <button class="btn btn-light" id="disable-recommend">Disable</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </li>
                    <!-- reset  -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          Reset
                        </a>
                        <div class="dropdown-menu">
                          <a class="dropdown-item reset-button" href="#" data-language="en">English</a>
                          <a class="dropdown-item reset-button" href="#" data-language="pl">Polish</a>
                        </div>
                    </li>
                </ul>
                <!-- seed input -->
                <form class="form-inline my-2 my-lg-0">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">seed</span>
                        </div>
                        <input class="form-control" type="text" class="form-control" id="seed" placeholder="seed"  data-toggle="tooltip" data-placement="bottom" title="Type this on a different device to get the same game">
                    </div>
                </form>

            </div>
        </nav>
        <div class="modal fade" id="about-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">About Words</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Simple website to keep track on a codenames game.</p>

                        <p>On laptops you need to <b>double-click</b> the words to select them.</p>

                        <p>Check out <i>Spy assistant</i> tab for an automated tool to recommend spymaster clues. It works best towards endgame.</p>
                    </div>
                    <div class="modal-footer">
                        <a class="btn btn-info" href="https://en.wikipedia.org/wiki/Codenames_(board_game)">Rules</a>
                        <a class="btn btn-info" href="https://github.com/siemanko/words/">Source</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="collapse" id="recommend">
                <div class="card">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item" style="height:3.5rem;">
                            <div id="recommend-blue-loader" class="spinner-grow text-primary" role="status"></div>
                            <font color="#77AAFF" size=4> <div id="recommend-blue"></div></font>
                        </li>
                        <li class="list-group-item" style="height:3.5rem;">
                            <div id="recommend-red-loader" class="spinner-grow text-danger" role="status"></div>
                            <font color="#FF8888" size=4> <div id="recommend-red"></div></font>
                        </li>
                    </ul>
                </div>
            </div>
            <div id="game">
            </div>
            <div class="float-right">
                <span
                   style="color:red"
                   data-toggle="tooltip"
                   data-placement="bottom"
                   title="Number of red tiles that weren't discovered yet.">
                   Red left: <span id="red-left"></span>
                </span>
                &nbsp;
                <span
                   style="color:blue"
                   data-toggle="tooltip"
                   data-placement="bottom"
                   align="right"
                   title="Number of blue tiles that weren't discovered yet.">
                   Blue left: <span id="blue-left"></span>
                </span>
            </div>
        </div>
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.3/seedrandom.min.js" integrity="sha256-64f1BOntWrbWIG++Jw3Ad4BSjTz8FG2DLeZ0kD3lLcc=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js"> </script>
        <script src="recommend/localStorageDB.js"></script>
        <script src="recommend/recommend.js"></script>
        <script>
            var game = {};
            game.num_rows = 5;
            game.num_cols = 5;
            game.words = [];
            game.revealed = [];
            game.allrevealed = false;
            game.type  = []
            game.error = null;
            game.show_recommend = false;
            game.risk = "0";
            game.num_guesses = "3";

            var random_comparer = function(a, b) {
                return 2 * Math.random() - 1;
            }
            var polish_words = ["afryka", "amazonka", "ambasada", "ambulans", "ameryka", "anglia", "anioł", "antarktyka", "atlantyda", "australia", "awaria", "aztek", "babka", "bal", "bank", "bar", "basen", "bawełna", "bałwan", "beczka", "belka", "berlin", "bermudy", "bicz", "blok", "bomba", "budowa", "but", "butelka", "bąk", "cebula", "centaur", "centrum", "chiny", "chochlik", "choroba", "ciało", "cień", "czapa", "czar", "czas", "czekolada", "czujka", "dania", "diament", "dinozaur", "dno", "doktor", "donice", "drzewo", "duch", "dusza", "dwór", "dywan", "dzień", "dziobak", "dziura", "dzięcioł", "dzwon", "egipt", "ekran", "europa", "fala", "fartuch", "feniks", "figura", "film", "flet", "foka", "francja", "francuz", "funt", "gaz", "geniusz", "gigant", "gnat", "gniazdko", "golf", "gotyk", "gołąb", "gra", "grabarz", "gracja", "grecja", "groszek", "grzmot", "grzyb", "guma", "guzik", "gwiazda", "góra", "gładki", "głowa", "hak", "helikopter", "himalaje", "holender", "hollywood", "hotel", "humor", "igła", "jabłko", "jagoda", "jaja", "jatka", "jednorożec", "jowisz", "język", "kaczor", "kalosz", "kamień", "kangur", "kaptur", "karawan", "kasa", "kasyno", "kciuk", "keczup", "kiwi", "klamka", "klatka", "klawisz", "klucz", "kod", "kolec", "komórka", "konar", "koncert", "kontakt", "kontrakt", "korona", "korzenie", "kostium", "kot", "kozioł", "koło", "koń", "kościół", "kość", "kraków", "krasnal", "krata", "kret", "kropka", "krzesło", "krzyż", "król", "królik", "królowa", "krówka", "kręgi", "księżniczka", "księżyc", "kucharz", "kwadrat", "lakier", "las", "laser", "laska", "lew", "limuzyna", "lina", "lina", "lis", "loch ness", "lody", "londyn", "lot", "lud", "maj", "maks", "mamut", "marchew", "masa", "materiał", "meksyk", "merkury", "miedź", "mikroskop", "milioner", "mistrz", "miód", "model", "moskwa", "most", "mucha", "mur", "muszla", "mysz", "napad", "nauczyciel", "naukowiec", "nektar", "niebo", "niedźwiedź", "niemcy", "ninja", "nić", "noc", "noga", "nora", "nos", "nowy jork", "nurek", "nóż", "obcy", "obsada", "ogier", "ogień", "ogon", "oko", "olej", "olimp", "oliwa", "opera", "opoka", "organy", "orzech", "orzeł", "ośmiornica", "pająk", "paleta", "paluszki", "pan", "papier", "pas", "pasta", "pazur", "pekin", "perła", "pielęgniarka", "pierścień", "pies", "pilot", "pingwin", "piramida", "pirat", "pistolet", "placek", "plastik", "plaża", "plik", "pochodnia", "pociecha", "pociąg", "poczta", "podkowa", "podkład", "pojazd", "pokrywka", "pole", "policja", "polska", "port", "powietrze", "połączenie", "praca", "prawnik", "prawo", "promień", "przewodnik", "pudło", "punkt", "pupil", "pustka", "północ", "płot", "płyta", "rak", "rakieta", "rama", "rekin", "rewolucja", "robak", "robot", "ruda", "rura", "ryba", "rycerz", "rzut", "rzym", "rząd", "rzęsa", "róg", "róża", "ręka", "rękawica", "samochód", "samolot", "satelita", "saturn", "serce", "siano", "siekacz", "sieć", "silnik", "siła", "skorpion", "skorupa", "smok", "soczewka", "sokół", "spadek", "spadochron", "splot", "stadion", "stan", "statek", "stopa", "stopień", "stołek", "strona", "strumień", "strzał", "stół", "sukienka", "superbohater", "szafa", "szczyt", "szczęście", "szekspir", "szkocja", "szkoła", "szkło", "szmugiel", "sznur", "szpieg", "szpilka", "szpital", "sztuka", "słup", "tablica", "talerz", "talia", "taniec", "tchórz", "teatr", "teleskop", "toaleta", "tokio", "torebka", "trawa", "trucizna", "truteń", "trójkąt", "trąba", "tuba", "tusz", "tusza", "ucho", "usta", "wachlarz", "waga", "waszyngton", "wiatr", "widelec", "wiedźma", "wieloryb", "wieża", "wieżowiec", "wiosna", "wkład", "woda", "wojna", "wstęp", "wybuch", "wydech", "wąż", "zamek", "zebra", "zespół", "zieleń", "ziemia", "zmiana", "zmywacz", "znak", "zwoje", "ząb", "złodziej", "złoto", "ława", "łożysko", "łuk", "łódź", "ślimak", "śmierć", "śnieg", "świerszcz", "świnia", "żabka", "żebro", "żelazo", "żołnierz", "żubr", "żuk", "żuraw", "życie"];
            var english_words = ["africa", "agent", "air", "alien", "alps", "amazon", "ambulance", "america", "angel", "antarctica", "apple", "arm", "atlantis", "australia", "aztec", "back", "ball", "band", "bank", "bar", "bark", "bat", "battery", "beach", "bear", "beat", "bed", "beijing", "bell", "belt", "berlin", "bermuda", "berry", "bill", "block", "board", "bolt", "bomb", "bond", "boom", "boot", "bottle", "bow", "box", "bridge", "brush", "buck", "buffalo", "bug", "bugle", "button", "calf", "canada", "cap", "capital", "car", "card", "carrot", "casino", "cast", "cat", "cell", "centaur", "center", "chair", "change", "charge", "check", "chest", "chick", "china", "chocolate", "church", "circle", "cliff", "cloak", "club", "code", "cold", "comic", "compound", "concert", "conductor", "contract", "cook", "copper", "cotton", "court", "cover", "crane", "crash", "cricket", "cross", "crown", "cycle", "czech", "dance", "date", "day", "death", "deck", "degree", "diamond", "dice", "dinosaur", "disease", "doctor", "dog", "draft", "dragon", "dress", "drill", "drop", "duck", "dwarf", "eagle", "egypt", "embassy", "engine", "england", "europe", "eye", "face", "fair", "fall", "fan", "fence", "field", "fighter", "figure", "file", "film", "fire", "fish", "flute", "fly", "foot", "force", "forest", "fork", "france", "game", "gas", "genius", "germany", "ghost", "giant", "glass", "glove", "gold", "grace", "grass", "greece", "green", "ground", "ham", "hand", "hawk", "head", "heart", "helicopter", "himalayas", "hole", "hollywood", "honey", "hood", "hook", "horn", "horse", "horseshoe", "hospital", "hotel", "ice", "icecream", "india", "iron", "ivory", "jack", "jam", "jet", "jupiter", "kangaroo", "ketchup", "key", "kid", "king", "kiwi", "knife", "knight", "lab", "lap", "laser", "lawyer", "lead", "lemon", "leprechaun", "life", "light", "limousine", "line", "link", "lion", "litter", "loch ness", "lock", "log", "london", "luck", "mail", "mammoth", "maple", "marble", "march", "mass", "match", "mercury", "mexico", "microscope", "millionaire", "mine", "mint", "missile", "model", "mole", "moon", "moscow", "mount", "mouse", "mouth", "mug", "nail", "needle", "net", "new york", "night", "ninja", "note", "novel", "nurse", "nut", "octopus", "oil", "olive", "olympus", "opera", "orange", "organ", "palm", "pan", "pants", "paper", "parachute", "park", "part", "pass", "paste", "penguin", "phoenix", "piano", "pie", "pilot", "pin", "pipe", "pirate", "pistol", "pit", "pitch", "plane", "plastic", "plate", "platypus", "play", "plot", "point", "poison", "pole", "police", "pool", "port", "post", "pound", "press", "princess", "pumpkin", "pupil", "pyramid", "queen", "rabbit", "racket", "ray", "revolution", "ring", "robin", "robot", "rock", "rome", "root", "rose", "roulette", "round", "row", "ruler", "satellite", "saturn", "scale", "school", "scientist", "scorpion", "screen", "scuba diver", "seal", "server", "shadow", "shakespeare", "shark", "ship", "shoe", "shop", "shot", "sink", "skyscraper", "slip", "slug", "smuggler", "snow", "snowman", "sock", "soldier", "soul", "sound", "space", "spell", "spider", "spike", "spine", "spot", "spring", "spy", "square", "stadium", "staff", "star", "state", "stick", "stock", "straw", "stream", "strike", "string", "sub", "suit", "superhero", "swing", "switch", "table", "tablet", "tag", "tail", "tap", "teacher", "telescope", "temple", "theater", "thief", "thumb", "tick", "tie", "time", "tokyo", "tooth", "torch", "tower", "track", "train", "triangle", "trip", "trunk", "tube", "turkey", "undertaker", "unicorn", "vacuum", "van", "vet", "wake", "wall", "war", "washer", "washington", "watch", "water", "wave", "web", "well", "whale", "whip", "wind", "witch", "worm", "yard"];
            var word_lists = {'en': english_words, 'pl': polish_words}
            function shuffled_array(arr) {
                arr = arr.slice();
                for (var i = arr.length - 1; i >= 1; --i) {
                    var j = getRandomInt(0, i + 1);
                    var temp = arr[i];
                    arr[i] = arr[j]
                    arr[j] = temp;
                }
                return arr;
            }

            function getRandomInt(min, max) {
                min = Math.ceil(min);
                max = Math.floor(max);
                return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
            }

            function getRemaining(c) {
                var res = 0;
                for (var idx = 0; idx < game.num_rows * game.num_cols; idx += 1) {
                    if (!game.revealed[idx] && game.type[idx] == c) {
                        res += 1;
                    }
                }
                return res;
            }

            function get_lang() {
                return $('#seed').val().split('-', 2)[0]
            }

            function recommend_needed() {
                return !game.error && game.allrevealed && game.show_recommend && get_lang() == 'en';
            }

            function hash(str) {
                var i = str.length
                var hash1 = 5381
                var hash2 = 52711

                while (i--) {
                    const char = str.charCodeAt(i)
                    hash1 = (hash1 * 33) ^ char
                    hash2 = (hash2 * 33) ^ char
                }

                return (hash1 >>> 0) * 4096 + (hash2 >>> 0)
            }


            function get_query_and_hash(color) {
                w = {r: [], b: [], n: [], e: []};
                var res = 0;
                for (var idx = 0; idx < game.num_rows * game.num_cols; idx += 1) {
                    if (!game.revealed[idx]) {
                        w[game.type[idx]].push(game.words[idx])
                    }
                }

                if (color == 'blue') {
                    var good = w.b;
                    var bad = w.r.concat(w.n);
                } else {
                    var good = w.r
                    var bad = w.b.concat(w.n);
                }
                var fail = w.e;
                if (good.length == 0) {
                    return [null, null];
                }

                var num_guesses = Math.min(good.length, parseInt(game.num_guesses));
                if (game.risk == 'allbutblack') {
                    bad = [];
                    var risk = 0;
                } else if (game.risk == 'all') {
                    bad = [];
                    fail = [];
                    var risk = 0;
                } else {
                    var risk = Math.min(parseInt(game.risk), bad.length);
                }

                function query() { return recommend(good, bad, fail, risk, num_guesses)};
                var query_hash = 'good:' + good.join(',') + ' bad:' + bad.join(',') +' fail:' + fail.join(',') +
                                 ' risk:' + risk + ' num_guesses:' + num_guesses;
                query_hash = hash(query_hash);
                return [query, query_hash];
            }

            var current_hash = {blue: null, red: null}
            function recommend_thread(color) {
                var loader = $('#recommend-' + color + '-loader');
                var text = $('#recommend-' + color);
                var wait_delay = 250;

                function invoke_self() {recommend_thread(color);}


                if (recommend_needed()) {
                    if (model === null) {
                        loader.show();
                        load_model(invoke_self);
                        return;
                    }
                    var [query, query_hash] = get_query_and_hash(color);

                    if (query_hash === null) {
                        loader.hide();
                        text.text('zero words left to guess.');
                        current_hash[color] = null;
                        setTimeout(invoke_self, wait_delay);
                        return;
                    }
                    if (current_hash[color] == query_hash) {
                        setTimeout(invoke_self, wait_delay);
                        return
                    }
                    text.text('');
                    loader.show();
                    setTimeout(function() {
                        query().then(function(value) {
                            loader.hide();
                            text.text(value.slice(0, 10).join(', '))
                            current_hash[color] = query_hash;
                            setTimeout(invoke_self, 0);
                        });
                    }, 10);
                } else {
                    setTimeout(invoke_self, wait_delay);
                }
            }


            function render() {
                var recommend = $('#recommend');
                var game_ui = $("#game");
                game_ui.html("");
                $('#risk').val(game.risk);
                $('#num-guesses').val(game.num_guesses);
                if (game.error) {
                    var p = $('<p class="lead" \>');
                    p.html(game.error);
                    game_ui.append(p);
                    recommend.collapse('hide');
                } else {
                    table = $('<table class="cards" />');
                    $('#spymaster-li').removeClass();
                    if (game.allrevealed) {
                        $('#spymaster-li').addClass("active");
                    }
                    if (game.show_recommend) {
                        $('#intro-recommend').hide();
                        $('#recommend-settings').show()
                    } else {
                        $('#intro-recommend').show();
                        $('#recommend-settings').hide()
                    }
                    for (var i=0; i < game.num_rows; i+=1) {
                        var row = $("<tr>")
                        for (var j=0; j < game.num_cols; j+=1) {
                            var idx = i * game.num_cols + j;
                            var cell = $("<td>")
                            cell.addClass("cell");
                            if (game.revealed[idx] || game.allrevealed) {
                                cell.addClass("cell-revealed");
                                if (game.type[idx] === "r") {
                                    cell.addClass("cell-red");
                                } else if (game.type[idx] === "b") {
                                    cell.addClass("cell-blue");
                                } else if (game.type[idx] === "n") {
                                    cell.addClass("cell-neutral");
                                } else if (game.type[idx] === "e") {
                                    cell.addClass("cell-end");
                                }
                                if (game.revealed[idx] && game.allrevealed) {
                                    cell.addClass("cell-strike");
                                }
                            } else {
                                cell.addClass("cell-inrevealed");
                            }
                            cell.dblclick(function(inner) { return function() { toggle_reveal(inner); }}(idx));
                            cell.on('touchend', function(inner) { return function() { toggle_reveal(inner); }}(idx));
                            var word = $("<span>");

                            word.text(game.words[idx])
                            word.addClass("cell-text")
                            cell.append(word);
                            row.append(cell);
                        }
                        table.append(row);
                    }
                    game_ui.append(table);
                    $('#red-left').text(getRemaining("r"));
                    $('#blue-left').text(getRemaining("b"));
                    recommend.collapse(recommend_needed() ? 'show' : 'hide')
                    if (get_lang() == 'en') {
                        $('#recommend-lang-warning').hide();
                    } else {
                        $('#recommend-lang-warning').show();
                    }
                }
                sessionStorage.setItem("game", JSON.stringify(game));
            }

            function toggle_reveal(idx) {
                game.revealed[idx] = !game.revealed[idx];
                render();
            }

            function toggle_spymaster() {
                game.allrevealed = !game.allrevealed;
                render();
            }

            function enable_recommend() {
                game.show_recommend = true;
                if (!game.allrevealed) {
                    game.allrevealed = true;
                }
                render();
            }

            function disable_recommend() {
                game.show_recommend = false;
                render();
            }

            function set_from_seed() {
                var seed = $('#seed').val().split('-', 2);
                sessionStorage.setItem("seed", JSON.stringify($('#seed').val()));

                game.error = null;
                if (seed.length != 2) {
                    game.error = "Seed must be of form <mark>lang</mark>-<mark>phrase</mark>, where <mark>lang</mark> is the language and <mark>phrase</mark> defines the board.";
                    render(); return;
                }
                var lang = seed[0];
                var seed = seed[1];
                if (!word_lists[lang]) {
                    game.error = "Language must be one of " + Object.keys(word_lists).sort().join(', ') + ".";
                    render(); return;
                }
                allwords = word_lists[lang];

                Math.seedrandom($('#seed').val());

                total = game.num_rows * game.num_cols;
                nthings = Math.floor(total / 3);
                game.type = [];
                for (var i = 0; i < nthings; i += 1) {
                    game.type.push("r");
                    game.type.push("b");
                }
                if (getRandomInt(0, 2) === 0) {
                    game.type.push("r");
                } else {
                    game.type.push("b");
                }
                game.type.push("e");
                for (var i = 0; i < total - (2 * nthings + 2); i += 1) {
                    game.type.push("n");
                }
                game.type = shuffled_array(game.type);

                game.revealed = [];
                for (var idx = 0; idx < game.num_rows * game.num_cols; idx += 1) { game.revealed.push(0); }
                game.words = shuffled_array(allwords).slice(0, total);
                render();
            }

            alphabet = "abcdefghijklmnopqrstuvwxyz"

            function int_to_string(seed) {
                var res = "";
                while (seed > 0) {
                    res += alphabet[seed % alphabet.length];
                    seed = Math.floor(seed / alphabet.length);
                }
                return res;
            }

            function reset(event) {
                var lang = "en";
                if (event) {
                    lang = $(event.toElement).attr("data-language");
                }
                console.log(lang);
                Math.seedrandom();
                seed = getRandomInt(0, 1e9);
                seed_str = lang + "-" + int_to_string(seed);
                $('#seed').val(seed_str);
                set_from_seed();
            }

            function update_risk() {
                game.risk = $('#risk').val();
                render()
            }

            function update_num_guesses() {
                game.num_guesses = $('#num-guesses').val();
                render();
            }

            var current_version = 2;

            function verify_storage() {
                if (sessionStorage.getItem('storage_version') < current_version) {
                    indexedDB.deleteDatabase('d2');
                    sessionStorage.clear();
                    sessionStorage.setItem('storage_version', current_version);
                    alert('Website was updated to new version! Deleting your old settings.')
                }
            }

            $(document).ready(function() {
                verify_storage();
                if (!('ontouchstart' in document.documentElement)) {
                     $('[data-toggle="tooltip"]').tooltip();
                }
                $("#spymaster").click(toggle_spymaster);
                $('#enable-recommend').click(enable_recommend);
                $('#disable-recommend').click(disable_recommend);
                $(".reset-button").click(reset);
                $("#seed").val(seed);
                $("#seed").keyup(set_from_seed);
                $("#risk").change(update_risk);
                $("#num-guesses").change(update_num_guesses);

                if (sessionStorage.getItem("game")) {
                    seed = JSON.parse(sessionStorage.getItem("seed"));
                    $('#seed').val(seed);
                    game = JSON.parse(sessionStorage.getItem("game"));
                    render();
                } else {
                    reset();
                }
                recommend_thread('red');
                recommend_thread('blue');

            });
        </script>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-102294427-1', 'auto');
          ga('send', 'pageview');
        </script>
    </body>
</html>
