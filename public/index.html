<html>
    <head>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta name="HandheldFriendly" content="true" />

        <style>
            body {
                padding-top: 70px;
                touch-action: none;
            }
            .table-style {
                width: 100%;
                border-collapse: separate;
                height: 100%;
                margin: 0px;
                border-spacing: 1rem 1rem;
            }

            .cell-style {
                border: 2px solid black;
                max-width: 0px;
                max-height: 0px;
                text-align: center;
            }

            .word {
                border-radius: 10px;
                font-weight: bold;
                font-size: 1.4vw;
            }

            .recommend-box {
                padding-top:2rem;
                padding-bottom:2rem;
                vertical-align: top;
            }

            .cell-inrevealed {
                border: 2px dotted black;
            }
            .cell-inrevealed:hover {
                border: 2px solid black;
                cursor: pointer;
            }
            .cell-revealed {
                border: 2px solid black;
                cursor: auto;
            }
            .cell-red {
                background: #FFCCCC;
            }
            .cell-blue {
                background: #99CCFF;
            }
            .cell-neutral {
                background: #eeeeee;
            }
            .cell-end {
                background: black;
                color: white;
            }
            .red-stats {
                color: red;
            }
            .blue-stats {
                color: blue;
            }
            .cell-strike {
                opacity: 0.2;
            }

            .cluemaster-control {
                height: 1px;
                padding: 0px;
            }

            .cluemaster-control .form-group {
                margin-bottom: 0px;
                padding-top: 0.5rem;
            }

            .cluemaster-control > form {
                margin: 0px;
            }

            @media (max-width: 768px) {
                .recommend-box {
                    padding-top:1rem;
                    padding-bottom:1rem;
                    font-size: 0.7rem;
                }

            }

            @media (max-width: 992px) {
                /* this fix from 2017 still works! */
                nav.navbar.fixed-top {
                    max-height:100%;
                    overflow-y:auto;
                }
            }

            @media (min-width: 768px) {
                .wide-non-mobile {
                    min-width: 25rem;
                }
            }

        </style>
    </head>
    <body>
        <div id="root"></div>
        <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
            <span class="navbar-brand">Words</span>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#menu" aria-controls="menu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="menu">
                <!-- navigation buttons -->
                <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                    <li class="nav-item"><a href='#' id="about" class="nav-link" data-toggle="modal" data-target="#about-modal">
                        <img src="icons/info.svg" style="height:2rem" />&nbsp;About
                    </a></li>
                    <li id="cluemaster-li"
                        class="nav-item"
                        data-toggle="tooltip"
                        data-placement="bottom"
                        title="Display the colors of all tiles.">
                        <a class="nav-link" href="#" id="cluemaster"><img src="icons/detective.svg" style="height:2rem" />&nbsp;Clue Master</a>
                    </li>
                    <!-- spy assistant  -->
                    <li class="nav-item dropdown">
                        <a class="nav-link" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          <img src="icons/ai.svg" style="height:2rem" />&nbsp;AI Clue Master
                        </a>
                        <div class="dropdown-menu text-muted wide-non-mobile">
                            <div class="form-group" id="recommend-lang-warning">
                                <div class="alert alert-warning" role="alert">
                                    Currently only works for english.
                                </div>
                            </div>
                            <div class="form-group d-block d-sm-none" id="recommend-lang-warning">
                                <div class="alert alert-warning" role="alert">
                                    Currently does not work on portrait mode. Flip your phone.
                                </div>
                            </div>
                            <div id="intro-recommend">
                                <form class="px-4 py-1">
                                    <div class="form-group text-justify">
                                        <small>Automated tool to recommend cluemaster clues. It works best towards endgame. It is based on the <a href="https://nlp.stanford.edu/projects/glove/">glove vectors</a>. This specific application was inspired by a <a href="https://jsomers.net/glove-codenames/">blog post</a> that I saw on hacker news.</small>
                                    </div>
                                    <div class="form-group text-center">
                                        <button class="btn btn-primary" id="enable-recommend">Enable</button>
                                    </div>
                                </form>
                            </div>
                            <div id="recommend-settings">
                                <h6 class="dropdown-header">Spy Assistant Settings</h6>

                                <form class="px-4 py-3">
                                    <div class="form-group">
                                        <label for="risk">
                                            Risk tolerance</br>
                                            <small>The number of bad words that are ignored when coming up with clues. Zeros words is the safest option, but might result in more awkward clues.</small>
                                        </label>
                                        <select class="form-control" id="risk">
                                            <option value="0">zero words</option>
                                            <option value="1">one word</option>
                                            <option value="2">two words</option>
                                            <option value="3">three words</option>
                                            <option value="allbutblack">all words (no black)</option>
                                            <option value="all">all words (including black)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="num-guesses">
                                            Target Words</br>
                                            <small>Number of words that the assistant will try to hint at. The larger the number the harder is it to come up with a sensible clue.</small>
                                        </label>
                                        <select class="form-control" id="num-guesses">
                                            <option value="1">one word</option>
                                            <option value="2">two words</option>
                                            <option value="3">three words</option>
                                            <option value="4">four words</option>
                                            <option value="all">all</option>
                                        </select>
                                    </div>
                                    <div class="form-group text-center">
                                        <button class="btn btn-light" id="disable-recommend">Disable</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                    </li>
                    <!-- reset  -->
                    <li class="nav-item dropdown">
                        <a class="nav-link" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          <img src="icons/reset.svg" style="height:2rem" />&nbsp;Reset
                        </a>
                        <div class="dropdown-menu">
                          <a class="dropdown-item reset-button" href="#" data-language="en">English</a>
                          <a class="dropdown-item reset-button" href="#" data-language="pl">Polish</a>
                        </div>
                    </li>

                </ul>
                <div class="nav-text">
                    <span
                       style="color:red"
                       data-toggle="tooltip"
                       data-placement="bottom"
                       title="Number of red tiles that weren't discovered yet.">
                       Red left: <span id="red-left"></span>
                    </span>
                    &nbsp;
                    <span
                       style="color:blue"
                       data-toggle="tooltip"
                       data-placement="bottom"
                       align="right"
                       title="Number of blue tiles that weren't discovered yet.">
                       Blue left: <span id="blue-left"></span>
                    </span>
                    &nbsp;
                    &nbsp;
                </div>
                <!-- seed input -->
                <form class="form-inline my-2 my-lg-0">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">seed</span>
                        </div>
                        <input class="form-control" type="text" class="form-control" id="seed" placeholder="seed"  data-toggle="tooltip" data-placement="bottom" title="Type this on a different device to get the same game">
                    </div>
                </form>

            </div>
        </nav>
        <div class="modal fade" id="about-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">About Words</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Simple website to keep track on a codenames game.</p>

                        <p>On laptops you need to <b>double-click</b> the words to select them.</p>

                        <p>Check out <i>Spy assistant</i> tab for an automated tool to recommend cluemaster clues. It works best towards endgame.</p>
                    </div>
                    <div class="modal-footer">
                        <a class="btn btn-info" href="https://en.wikipedia.org/wiki/Codenames_(board_game)">Rules</a>
                        <a class="btn btn-info" href="https://github.com/siemanko/words/">Source</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="container-fluid h-100">
            <div class="row h-100">
                <div class="col-3 col-lg-2 collapse d-none d-sm-block" id="recommend">
                    <div class="row h-100">
                        <div class="col" >
                            <table class="table-style" style="border-spacing: 0rem 1rem;">
                                <tr id="auto-cluemaster-control">
                                    <td class="cell-style align-middle cluemaster-control">
                                        <form>
                                          <div class="form-group">
                                            <label for="auto-cluemaster" style="margin-left: 0.5rem; margin-right: 0.5rem">Select the number of words to guess for <span id='auto-cluemaster-next-player'></span>.</label>
                                            <div class="btn-group w-100" role="group" id="auto-cluemaster">
                                              <button type="button" class="btn btn-light" data-value="1">1</button>
                                              <button type="button" class="btn btn-light" data-value="2">2</button>
                                              <button type="button" class="btn btn-light" data-value="3">3</button>
                                              <button type="button" class="btn btn-light" data-value="4">4</button>
                                              <button type="button" class="btn btn-light" data-value="all">∞</button>
                                            </div>
                                          </div>
                                        </form>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="recommend-box cell-style" id="recommend-box-red">

                                    </td>
                                </tr>
                                <tr>
                                    <td class="recommend-box cell-style" id="recommend-box-blue">

                                    </td>
                                </tr>
                            </table >
                        </div>
                    </div>
                </div>
                <div class="col" id="game"></div>
            </div>
        </div>
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/1.4.0/tf.min.js" integrity="sha256-0xpIbQVMu7ekp6wgrZGYe6q4myjGVdLTlFjcV1sk2Tg=" crossorigin="anonymous"></script>
        <script src="recommend/localStorageDB.js"></script>
        <script src="seeded_shuffle.js"></script>
        <script src="recommend/recommend.js"></script>
        <script>
            var game = {};
            game.num_rows = 5;
            game.num_cols = 5;
            game.words = [];
            game.revealed = [];
            game.allrevealed = false;
            game.type  = []
            game.error = null;
            game.show_recommend = false;
            game.risk = "0";
            game.num_guesses = "3";
            game.auto_clues = {
                red: [],
                blue: [],
            }

            recommended_words = {}
            recommended_words.blue = null;
            recommended_words.red = null;

            var polish_words = ["afryka", "amazonka", "ambasada", "ambulans", "ameryka", "anglia", "anioł", "antarktyka", "atlantyda", "australia", "awaria", "aztek", "babka", "bal", "bank", "bar", "basen", "bawełna", "bałwan", "beczka", "belka", "berlin", "bermudy", "bicz", "blok", "bomba", "budowa", "but", "butelka", "bąk", "cebula", "centaur", "centrum", "chiny", "chochlik", "choroba", "ciało", "cień", "czapa", "czar", "czas", "czekolada", "czujka", "dania", "diament", "dinozaur", "dno", "doktor", "donice", "drzewo", "duch", "dusza", "dwór", "dywan", "dzień", "dziobak", "dziura", "dzięcioł", "dzwon", "egipt", "ekran", "europa", "fala", "fartuch", "feniks", "figura", "film", "flet", "foka", "francja", "francuz", "funt", "gaz", "geniusz", "gigant", "gnat", "gniazdko", "golf", "gotyk", "gołąb", "gra", "grabarz", "gracja", "grecja", "groszek", "grzmot", "grzyb", "guma", "guzik", "gwiazda", "góra", "gładki", "głowa", "hak", "helikopter", "himalaje", "holender", "hollywood", "hotel", "humor", "igła", "jabłko", "jagoda", "jaja", "jatka", "jednorożec", "jowisz", "język", "kaczor", "kalosz", "kamień", "kangur", "kaptur", "karawan", "kasa", "kasyno", "kciuk", "keczup", "kiwi", "klamka", "klatka", "klawisz", "klucz", "kod", "kolec", "komórka", "konar", "koncert", "kontakt", "kontrakt", "korona", "korzenie", "kostium", "kot", "kozioł", "koło", "koń", "kościół", "kość", "kraków", "krasnal", "krata", "kret", "kropka", "krzesło", "krzyż", "król", "królik", "królowa", "krówka", "kręgi", "księżniczka", "księżyc", "kucharz", "kwadrat", "lakier", "las", "laser", "laska", "lew", "limuzyna", "lina", "lina", "lis", "loch ness", "lody", "londyn", "lot", "lud", "maj", "maks", "mamut", "marchew", "masa", "materiał", "meksyk", "merkury", "miedź", "mikroskop", "milioner", "mistrz", "miód", "model", "moskwa", "most", "mucha", "mur", "muszla", "mysz", "napad", "nauczyciel", "naukowiec", "nektar", "niebo", "niedźwiedź", "niemcy", "ninja", "nić", "noc", "noga", "nora", "nos", "nowy jork", "nurek", "nóż", "obcy", "obsada", "ogier", "ogień", "ogon", "oko", "olej", "olimp", "oliwa", "opera", "opoka", "organy", "orzech", "orzeł", "ośmiornica", "pająk", "paleta", "paluszki", "pan", "papier", "pas", "pasta", "pazur", "pekin", "perła", "pielęgniarka", "pierścień", "pies", "pilot", "pingwin", "piramida", "pirat", "pistolet", "placek", "plastik", "plaża", "plik", "pochodnia", "pociecha", "pociąg", "poczta", "podkowa", "podkład", "pojazd", "pokrywka", "pole", "policja", "polska", "port", "powietrze", "połączenie", "praca", "prawnik", "prawo", "promień", "przewodnik", "pudło", "punkt", "pupil", "pustka", "północ", "płot", "płyta", "rak", "rakieta", "rama", "rekin", "rewolucja", "robak", "robot", "ruda", "rura", "ryba", "rycerz", "rzut", "rzym", "rząd", "rzęsa", "róg", "róża", "ręka", "rękawica", "samochód", "samolot", "satelita", "saturn", "serce", "siano", "siekacz", "sieć", "silnik", "siła", "skorpion", "skorupa", "smok", "soczewka", "sokół", "spadek", "spadochron", "splot", "stadion", "stan", "statek", "stopa", "stopień", "stołek", "strona", "strumień", "strzał", "stół", "sukienka", "superbohater", "szafa", "szczyt", "szczęście", "szekspir", "szkocja", "szkoła", "szkło", "szmugiel", "sznur", "szpieg", "szpilka", "szpital", "sztuka", "słup", "tablica", "talerz", "talia", "taniec", "tchórz", "teatr", "teleskop", "toaleta", "tokio", "torebka", "trawa", "trucizna", "truteń", "trójkąt", "trąba", "tuba", "tusz", "tusza", "ucho", "usta", "wachlarz", "waga", "waszyngton", "wiatr", "widelec", "wiedźma", "wieloryb", "wieża", "wieżowiec", "wiosna", "wkład", "woda", "wojna", "wstęp", "wybuch", "wydech", "wąż", "zamek", "zebra", "zespół", "zieleń", "ziemia", "zmiana", "zmywacz", "znak", "zwoje", "ząb", "złodziej", "złoto", "ława", "łożysko", "łuk", "łódź", "ślimak", "śmierć", "śnieg", "świerszcz", "świnia", "żabka", "żebro", "żelazo", "żołnierz", "żubr", "żuk", "żuraw", "życie"];
            var english_words = ["africa", "agent", "air", "alien", "alps", "amazon", "ambulance", "america", "angel", "antarctica", "apple", "arm", "atlantis", "australia", "aztec", "back", "ball", "band", "bank", "bar", "bark", "bat", "battery", "beach", "bear", "beat", "bed", "beijing", "bell", "belt", "berlin", "bermuda", "berry", "bill", "block", "board", "bolt", "bomb", "bond", "boom", "boot", "bottle", "bow", "box", "bridge", "brush", "buck", "buffalo", "bug", "bugle", "button", "calf", "canada", "cap", "capital", "car", "card", "carrot", "casino", "cast", "cat", "cell", "centaur", "center", "chair", "change", "charge", "check", "chest", "chick", "china", "chocolate", "church", "circle", "cliff", "cloak", "club", "code", "cold", "comic", "compound", "concert", "conductor", "contract", "cook", "copper", "cotton", "court", "cover", "crane", "crash", "cricket", "cross", "crown", "cycle", "czech", "dance", "date", "day", "death", "deck", "degree", "diamond", "dice", "dinosaur", "disease", "doctor", "dog", "draft", "dragon", "dress", "drill", "drop", "duck", "dwarf", "eagle", "egypt", "embassy", "engine", "england", "europe", "eye", "face", "fair", "fall", "fan", "fence", "field", "fighter", "figure", "file", "film", "fire", "fish", "flute", "fly", "foot", "force", "forest", "fork", "france", "game", "gas", "genius", "germany", "ghost", "giant", "glass", "glove", "gold", "grace", "grass", "greece", "green", "ground", "ham", "hand", "hawk", "head", "heart", "helicopter", "himalayas", "hole", "hollywood", "honey", "hood", "hook", "horn", "horse", "horseshoe", "hospital", "hotel", "ice", "icecream", "india", "iron", "ivory", "jack", "jam", "jet", "jupiter", "kangaroo", "ketchup", "key", "kid", "king", "kiwi", "knife", "knight", "lab", "lap", "laser", "lawyer", "lead", "lemon", "leprechaun", "life", "light", "limousine", "line", "link", "lion", "litter", "loch ness", "lock", "log", "london", "luck", "mail", "mammoth", "maple", "marble", "march", "mass", "match", "mercury", "mexico", "microscope", "millionaire", "mine", "mint", "missile", "model", "mole", "moon", "moscow", "mount", "mouse", "mouth", "mug", "nail", "needle", "net", "new york", "night", "ninja", "note", "novel", "nurse", "nut", "octopus", "oil", "olive", "olympus", "opera", "orange", "organ", "palm", "pan", "pants", "paper", "parachute", "park", "part", "pass", "paste", "penguin", "phoenix", "piano", "pie", "pilot", "pin", "pipe", "pirate", "pistol", "pit", "pitch", "plane", "plastic", "plate", "platypus", "play", "plot", "point", "poison", "pole", "police", "pool", "port", "post", "pound", "press", "princess", "pumpkin", "pupil", "pyramid", "queen", "rabbit", "racket", "ray", "revolution", "ring", "robin", "robot", "rock", "rome", "root", "rose", "roulette", "round", "row", "ruler", "satellite", "saturn", "scale", "school", "scientist", "scorpion", "screen", "scuba diver", "seal", "server", "shadow", "shakespeare", "shark", "ship", "shoe", "shop", "shot", "sink", "skyscraper", "slip", "slug", "smuggler", "snow", "snowman", "sock", "soldier", "soul", "sound", "space", "spell", "spider", "spike", "spine", "spot", "spring", "spy", "square", "stadium", "staff", "star", "state", "stick", "stock", "straw", "stream", "strike", "string", "sub", "suit", "superhero", "swing", "switch", "table", "tablet", "tag", "tail", "tap", "teacher", "telescope", "temple", "theater", "thief", "thumb", "tick", "tie", "time", "tokyo", "tooth", "torch", "tower", "track", "train", "triangle", "trip", "trunk", "tube", "turkey", "undertaker", "unicorn", "vacuum", "van", "vet", "wake", "wall", "war", "washer", "washington", "watch", "water", "wave", "web", "well", "whale", "whip", "wind", "witch", "worm", "yard"];
            var word_lists = {'en': english_words, 'pl': polish_words}

            function getRandomInt(min, max) {
                min = Math.ceil(min);
                max = Math.floor(max);
                return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
            }

            function get_remaining(c) {
                var res = 0;
                for (var idx = 0; idx < game.num_rows * game.num_cols; idx += 1) {
                    if (!game.revealed[idx] && game.type[idx] == c) {
                        res += 1;
                    }
                }
                return res;
            }

            function get_lang() {
                return $('#seed').val().split('-', 2)[0]
            }

            function recommend_needed() {
                return !game.error && game.show_recommend && get_lang() == 'en';
            }

            function hash(str) {
                var i = str.length
                var hash1 = 5381
                var hash2 = 52711

                while (i--) {
                    const char = str.charCodeAt(i)
                    hash1 = (hash1 * 33) ^ char
                    hash2 = (hash2 * 33) ^ char
                }

                return (hash1 >>> 0) * 4096 + (hash2 >>> 0)
            }


            function get_query_and_hash(color) {
                w = {r: [], b: [], n: [], e: []};
                var res = 0;
                for (var idx = 0; idx < game.num_rows * game.num_cols; idx += 1) {
                    if (!game.revealed[idx]) {
                        w[game.type[idx]].push(game.words[idx])
                    }
                }

                if (color == 'blue') {
                    var good = w.b;
                    var bad = w.r.concat(w.n);
                } else {
                    var good = w.r
                    var bad = w.b.concat(w.n);
                }
                var fail = w.e;
                if (good.length == 0) {
                    return [null, null];
                }
                if (game.num_guesses == 'all') {
                    var num_guesses = good.length;
                } else {
                    var num_guesses = Math.min(good.length, parseInt(game.num_guesses));
                }
                if (game.risk == 'allbutblack') {
                    bad = [];
                    var risk = 0;
                } else if (game.risk == 'all') {
                    bad = [];
                    fail = [];
                    var risk = 0;
                } else {
                    var risk = Math.min(parseInt(game.risk), bad.length);
                }

                function query() { return recommend(good, bad, fail, risk, num_guesses)};
                var query_hash = 'good:' + good.join(',') + ' bad:' + bad.join(',') +' fail:' + fail.join(',') +
                                 ' risk:' + risk + ' num_guesses:' + num_guesses;
                query_hash = hash(query_hash);
                return [query, query_hash];
            }

            var current_hash = {blue: null, red: null}
            function cluemaster_recommend_thread(color) {
                var wait_delay = 250;

                function invoke_self() {cluemaster_recommend_thread(color);}


                if (recommend_needed() && game.allrevealed) {
                    if (model === null) {
                        load_model(invoke_self);
                        return;
                    }
                    var [query, query_hash] = get_query_and_hash(color);

                    if (query_hash === null) {
                        recommended_words[color] = ['no words left to guess.']
                        current_hash[color] = null;
                        setTimeout(invoke_self, wait_delay);
                        return;
                    }
                    if (current_hash[color] == query_hash) {
                        setTimeout(invoke_self, wait_delay);
                        return
                    }
                    recommended_words[color] = null;
                    setTimeout(function() {
                        query().then(function(value) {
                            recommended_words[color] = value;
                            current_hash[color] = query_hash;
                            render();
                            setTimeout(invoke_self, 0);
                        });
                    }, 10);
                } else {
                    setTimeout(invoke_self, wait_delay);
                }
            }

            function render_recommend() {
                var recommend = $('#recommend');
                if (recommend_needed()) {
                    recommend.addClass('d-none');
                    recommend.addClass('d-sm-block');
                    recommend.collapse('show');
                    if (game.allrevealed) {
                        $('#auto-cluemaster-control').hide();
                        for (var color of ['red', 'blue']) {
                            var box = $('#recommend-box-' + color);
                            box.html('');
                            var flavor = (color == 'red') ? 'danger' : 'primary';
                            if (recommended_words[color] === null) {
                                box.append('<div class="spinner-grow spinner-grow-sm align-middle text-' + flavor + '" role="status"/>')
                            } else {
                                word_list = $('<span class="text-' + flavor + '"/>')
                                word_list.html(recommended_words[color].slice(0, 8).join('<br>'));
                                box.append(word_list)
                            }
                        }
                    } else {
                        $('#auto-cluemaster-control').show();
                        var np = $('#auto-cluemaster-next-player')
                        np.removeClass();
                        np.addClass('text-' + (next_player() == 'red' ? 'danger' : 'primary'));
                        np.text(next_player());

                        $('#auto-cluemaster button').prop('disabled', get_remaining('b') == 0 || get_remaining('r') == 0);

                        for (var color of ['red', 'blue']) {
                            var box = $('#recommend-box-' + color);
                            box.html('');
                            var flavor = (color == 'red') ? 'danger' : 'primary';

                            if (game.auto_clues[color].length == 0) {
                                box.append('<span class="text-' + flavor + '"> No clues.</span>');
                            } else {
                                var clues = game.auto_clues[color];
                                for (var i = 0; i < clues.length; i++) {
                                    var opacity = 0.4;
                                    if (i + 1 == clues.length && color != next_player()) {
                                        opacity = 1.0;
                                    }
                                    if (clues[i] === null) {
                                        box.append('<div class="spinner-grow spinner-grow-sm align-middle text-' + flavor + '" role="status"/>')
                                    } else {
                                        box.append($('<span style="opacity: ' + opacity + '" class="text-' + flavor + '">' + clues[i] + '</span>'));
                                    }
                                    if (i + 1 < clues.length) {
                                        box.append($('<br />'));
                                    }
                                }
                            }
                        }
                    }
                } else {
                    recommend.collapse('hide');
                    recommend.removeClass('d-none');
                    recommend.removeClass('d-sm-block');
                }
            }

            function render() {
                var game_ui = $("#game");
                game_ui.html("");
                $('#risk').val(game.risk);
                $('#num-guesses').val(game.num_guesses);
                if (game.error) {
                    var p = $('<p class="lead" \>');
                    p.html(game.error);
                    game_ui.append(p);
                    $('#recommend').collapse('hide');
                } else {
                    table = $('<table class="table-style"/>');
                    $('#cluemaster-li').removeClass();
                    if (game.allrevealed) {
                        $('#cluemaster-li').addClass("active");
                    }
                    if (game.show_recommend) {
                        $('#intro-recommend').hide();
                        $('#recommend-settings').show()
                    } else {
                        $('#intro-recommend').show();
                        $('#recommend-settings').hide()
                    }
                    for (var i=0; i < game.num_rows; i+=1) {
                        var row = $("<tr>")
                        for (var j=0; j < game.num_cols; j+=1) {
                            var idx = i * game.num_cols + j;
                            var cell = $("<td>")
                            cell.addClass("cell-style");
                            cell.addClass("word");
                            if (game.revealed[idx] || game.allrevealed) {
                                cell.addClass("cell-revealed");
                                if (game.type[idx] === "r") {
                                    cell.addClass("cell-red");
                                } else if (game.type[idx] === "b") {
                                    cell.addClass("cell-blue");
                                } else if (game.type[idx] === "n") {
                                    cell.addClass("cell-neutral");
                                } else if (game.type[idx] === "e") {
                                    cell.addClass("cell-end");
                                }
                                if (game.revealed[idx] && game.allrevealed) {
                                    cell.addClass("cell-strike");
                                }
                            } else {
                                cell.addClass("cell-inrevealed");
                            }
                            cell.dblclick(function(inner) { return function() { toggle_reveal(inner); }}(idx));
                            cell.on('touchend', function(inner) { return function() { toggle_reveal(inner); }}(idx));
                            var word = $("<span>");

                            word.text(game.words[idx])
                            word.addClass("cell-text");
                            cell.append(word);
                            row.append(cell);
                        }
                        table.append(row);
                    }
                    game_ui.append(table);
                    $('#red-left').text(get_remaining("r"));
                    $('#blue-left').text(get_remaining("b"));
                    render_recommend();
                    if (get_lang() == 'en') {
                        $('#recommend-lang-warning').hide();
                    } else {
                        $('#recommend-lang-warning').show();
                    }
                }
                sessionStorage.setItem("game", JSON.stringify(game));
            }

            function toggle_reveal(idx) {
                game.revealed[idx] = !game.revealed[idx];
                recommended_words.blue = null;
                recommended_words.red = null;
                render();
            }

            function toggle_cluemaster() {
                game.allrevealed = !game.allrevealed;
                render();
            }

            function enable_recommend() {
                game.show_recommend = true;
                if (!game.allrevealed) {
                    game.allrevealed = true;
                }
                render();
            }

            function disable_recommend() {
                game.show_recommend = false;
                render();
            }

            function set_from_seed() {
                var seed = $('#seed').val().split('-', 2);
                sessionStorage.setItem("seed", JSON.stringify($('#seed').val()));

                game.error = null;
                if (seed.length != 2) {
                    game.error = "Seed must be of form <mark>lang</mark>-<mark>phrase</mark>, where <mark>lang</mark> is the language and <mark>phrase</mark> defines the board.";
                    render(); return;
                }
                var lang = seed[0];
                var seed = seed[1];
                if (!word_lists[lang]) {
                    game.error = "Language must be one of " + Object.keys(word_lists).sort().join(', ') + ".";
                    render(); return;
                }
                allwords = word_lists[lang];

                total = game.num_rows * game.num_cols;
                nthings = Math.floor(total / 3);
                game.type = [];
                reds_and_blues = []
                for (var i = 0; i < nthings + 1; i += 1) {
                    reds_and_blues.push("r");
                    reds_and_blues.push("b");
                }
                var reds_and_blues = seeded_shuffle.shuffle(reds_and_blues, seed, true).slice(0, reds_and_blues.length - 1);
                for (var color of reds_and_blues) {
                    game.type.push(color);
                }
                console.log(reds_and_blues)

                game.type.push("e");
                for (var i = 0; i < total - (2 * nthings + 2); i += 1) {
                    game.type.push("n");
                }
                game.type = seeded_shuffle.shuffle(game.type, seed, true);

                game.revealed = [];
                for (var idx = 0; idx < game.num_rows * game.num_cols; idx += 1) { game.revealed.push(0); }
                game.words = seeded_shuffle.shuffle(allwords, seed, true).slice(0, total);
                game.auto_clues.red = [];
                game.auto_clues.blue = [];
                render();
            }

            alphabet = "abcdefghijklmnopqrstuvwxyz"

            function int_to_string(seed) {
                var res = "";
                while (seed > 0) {
                    res += alphabet[seed % alphabet.length];
                    seed = Math.floor(seed / alphabet.length);
                }
                return res;
            }

            function reset(event) {
                var lang = "en";
                if (event) {
                    lang = $(event.toElement).attr("data-language");
                }
                console.log(lang);
                seed = getRandomInt(0, 1e9);
                seed_str = lang + "-" + int_to_string(seed);
                $('#seed').val(seed_str);
                set_from_seed();
            }

            function update_risk() {
                game.risk = $('#risk').val();
                render()
            }

            function update_num_guesses() {
                game.num_guesses = $('#num-guesses').val();
                render();
            }

            function next_player() {
                var num_red = game.type.filter(x => x == 'r').length;
                var num_blue = game.type.filter(x => x == 'b').length;
                var turns_so_far = game.auto_clues.red.length + game.auto_clues.blue.length;
                if (num_red > num_blue) {
                    var order = ['red', 'blue'];
                } else {
                    var order = ['blue', 'red'];
                }
                return order[turns_so_far % 2];
            }

            function next_clue(event) {
                if (model === null) {
                    load_model(function() {next_clue(event);});
                    return;
                }
                game.num_guesses = $(event.target).attr('data-value');
                var color = next_player();
                game.auto_clues[color].push(null);
                var idx = game.auto_clues[color].length - 1
                render();
                setTimeout(function() {
                    get_query_and_hash(color)[0]().then(function(value) {
                        // TODO: blacklist
                        var ng = (game.num_guesses == 'all' ? '∞' : game.num_guesses);
                        game.auto_clues[color][idx] = value[0] + ' ' + ng;
                        render();
                    });
                }, 0)
            }

            var current_version = 3;

            function verify_storage() {
                var stored_version = sessionStorage.getItem('storage_version')
                if (stored_version < current_version) {
                    indexedDB.deleteDatabase('d2');
                    sessionStorage.clear();
                    sessionStorage.setItem('storage_version', current_version);
                    if (stored_version !== null) {
                        alert('Website was updated to new version! Deleting your old settings.')
                    }
                }
            }

            $(document).ready(function() {
                verify_storage();
                if (!('ontouchstart' in document.documentElement)) {
                     $('[data-toggle="tooltip"]').tooltip();
                }
                $("#cluemaster").click(toggle_cluemaster);
                $('#enable-recommend').click(enable_recommend);
                $('#disable-recommend').click(disable_recommend);
                $(".reset-button").click(reset);

                $("#about, #cluemaster, .reset-button").click(function() { $('#menu').collapse('hide') });

                $("#seed").val(seed);
                $("#seed").keyup(set_from_seed);
                $("#risk").change(update_risk);
                $("#num-guesses").change(update_num_guesses);
                $('#auto-cluemaster button').click(next_clue);

                if (sessionStorage.getItem("game")) {
                    seed = JSON.parse(sessionStorage.getItem("seed"));
                    $('#seed').val(seed);
                    game = JSON.parse(sessionStorage.getItem("game"));
                    render();
                } else {
                    reset();
                }
                cluemaster_recommend_thread('red');
                cluemaster_recommend_thread('blue');
            });
        </script>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-102294427-1', 'auto');
          ga('send', 'pageview');
        </script>
    </body>
</html>
